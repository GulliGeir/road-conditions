<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Iceland Road &amp; Weather Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link
    href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map { position:absolute; top:0; left:0; right:0; bottom:0; }
    .controls {
      position: absolute; top:10px; left:10px; z-index:999;
      background: rgba(255,255,255,0.9);
      padding: 8px 12px; border-radius:6px;
    }
    .controls label { font-size:14px; }
    .maplibregl-popup-content { padding:0!important; }
  </style>
</head>
<body>

  <div class="controls">
    <label><input type="checkbox" id="weather-toggle" /> Show Weather</label>
  </div>
  <div id="map"></div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    // ── CONFIG ───────────────────────────────────────
    const CLUSTER_BREAK_Z    = 10;
    const WEATHER_POPUP_MAX  = 8;    // ← max number of weather popups
    const proxy              = 'https://road-conditions.vercel.app/api/proxy?url=';
    const weatherURL         = proxy + encodeURIComponent('https://gagnaveita.vegagerdin.is/api/vedur2014_1');

    // ── INIT MAP ─────────────────────────────────────
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://api.maptiler.com/maps/0196e78d-8743-7dbf-90f5-cbede6455991/style.json?key=pbPr4x1AY4Yr8ic8iItZ',
      center: [-19.02,64.96],
      zoom: 5,
      minZoom: 5,
      maxBounds: [[-25,62.5],[-12,67.5]]
    });
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    // ── ROAD STATUS STYLING ───────────────────────────
    const statusColors = {
      'GREIDFAERT':'#00ff00','HALKA':'#ffff00','HALKUBLETTIR':'#ff9900',
      'LOKAD':'#ff0000','OFAERT_VEDUR':'#ff0000','OFAERT_ANNAD':'#ff0000',
      'SNJOTHEKJA':'#cccccc','THAEFINGUR':'#ffffff','FAERT_FJALLABILUM':'#00cc00',
      'THUNGFAERT':'#000000','KRAP':'#999999','OTHEKKT':'#999999',
      'FLUGHALT':'#0000ff','EKKI_I_THJONUSTU':'#999999'
    };
    const darkerColors = {
      'GREIDFAERT':'#008b1a','HALKA':'#005b99','HALKUBLETTIR':'#c17300',
      'LOKAD':'#800000','OFAERT_VEDUR':'#800000','OFAERT_ANNAD':'#800000',
      'SNJOTHEKJA':'#cccccc','THAEFINGUR':'#d150d1','FAERT_FJALLABILUM':'#027f17',
      'THUNGFAERT':'#1f1f1f','KRAP':'#6a6a6a','OTHEKKT':'#6a6a6a',
      'FLUGHALT':'#000099','EKKI_I_THJONUSTU':'#6a6a6a'
    };
    const statusText = {
      'GREIDFAERT':'Easily passable','HALKA':'Slippery','HALKUBLETTIR':'Some slippery spots',
      'LOKAD':'Closed','OFAERT_VEDUR':'Impassable due to weather','OFAERT_ANNAD':'Impassable',
      'SNJOTHEKJA':'Snow covered','THAEFINGUR':'Drift snow','FAERT_FJALLABILUM':'4×4 only',
      'THUNGFAERT':'Heavy traffic','KRAP':'Slush','OTHEKKT':'Unknown',
      'FLUGHALT':'Extremely slippery','EKKI_I_THJONUSTU':'Out of service'
    };

    function removeHighlight() {
      if (map.getLayer('highlighted-road')) map.removeLayer('highlighted-road');
      if (map.getSource('highlighted-road')) map.removeSource('highlighted-road');
    }

    // ── LOAD & STYLE ROAD LAYERS ────────────────────
    async function loadRoadLayer(id, arcgisId, minz, maxz) {
      const src   = `road-${id}`,
            line  = `${id}-line`,
            click = `${line}-click`,
            hov   = `${line}-hover`;

      // Base line
      map.addSource(src, { type:'geojson', data:{ type:'FeatureCollection', features:[] } });
      map.addLayer({
        id: line, type:'line', source:src, minzoom:minz,
        ...(maxz?{maxzoom:maxz}:{}),
        paint:{
          'line-color':['match',['get','ASTAND_YFIRBORD'], ...Object.entries(statusColors).flat(), '#000'],
          'line-width':4
        }
      });

      // Invisible wide line for clicks
      map.addLayer({
        id: click, type:'line', source:src, minzoom:minz,
        ...(maxz?{maxzoom:maxz}:{}),
        paint:{ 'line-color':'#000','line-opacity':0,'line-width':10 }
      });

      // Hover effect
      map.addLayer({
        id: hov, type:'line', source:src, minzoom:minz,
        ...(maxz?{maxzoom:maxz}:{}),
        paint:{
          'line-color':'#3388ff','line-width':6,
          'line-opacity':['case',['boolean',['feature-state','hover'],false],1,0]
        }
      });

      // Fetch all segments (paging)
      const base = `https://vegasja.vegagerdin.is/arcgis/rest/services/appfaerd/faerd1_2/MapServer/${arcgisId}`;
      const Q = base + 
        `/query?where=1%3D1&outFields=NRVEGUR,ASTAND_YFIRBORD&outSR=4326&f=geojson&resultRecordCount=1000`;
      let all = [], offset=0, more=true;
      while(more){
        const r = await fetch(`${Q}&resultOffset=${offset}`);
        const j = await r.json();
        all = all.concat(j.features);
        more = j.exceededTransferLimit;
        offset += j.features.length;
      }
      all.forEach((f,i)=>f.id=i);
      map.getSource(src).setData({ type:'FeatureCollection', features:all });

      // ─── CLICK: highlight every contiguous segment ──
      map.on('click', click, e => {
        const P = e.features[0].properties;
        removeHighlight();

        // pull in every feature with same NRVEGUR
        const roadSegments = map.querySourceFeatures(src, {
          filter: ['==',['get','NRVEGUR'], P.NRVEGUR]
        });

        map.addSource('highlighted-road', {
          type:'geojson',
          data: { type:'FeatureCollection', features: roadSegments }
        });
        map.addLayer({
          id:'highlighted-road',
          type:'line',
          source:'highlighted-road',
          paint:{ 'line-color':darkerColors[P.ASTAND_YFIRBORD], 'line-width':6 }
        });

        // pop-up (unchanged)
        const html = `
          <div style="font-family:sans-serif;">
            <div style="
              background:#000;color:#fff;font-weight:bold;font-size:15px;
              padding:8px 10px;display:flex;justify-content:space-between;
              border-radius:8px 8px 0 0;
            ">
              <span>Route ${P.NRVEGUR}</span>
              <button onclick="this.closest('.maplibregl-popup').remove();removeHighlight();"
                style="background:none;border:none;color:white;font-size:16px;cursor:pointer;">
                ×
              </button>
            </div>
            <div style="
              background:#fff;padding:12px;display:flex;align-items:center;
              border-radius:0 0 8px 8px;
            ">
              <span style="
                width:36px;height:12px;background:${statusColors[P.ASTAND_YFIRBORD]};
                border-radius:8px;margin-right:10px;
              "></span>
              <span style="font-size:14px;font-weight:600;">
                ${statusText[P.ASTAND_YFIRBORD]}
              </span>
            </div>
          </div>`;
        new maplibregl.Popup({ closeButton:false })
          .setLngLat(e.lngLat)
          .setHTML(html)
          .addTo(map);
      });

      // ─── HOVER: feature-state styling ───────────────
      let hovered = null;
      map.on('mousemove', click, e => {
        map.getCanvas().style.cursor = 'pointer';
        if (hovered !== null)
          map.setFeatureState({ source:src, id:hovered }, { hover:false });
        hovered = e.features[0].id;
        map.setFeatureState({ source:src, id:hovered }, { hover:true });
      });
      map.on('mouseleave', click, () => {
        map.getCanvas().style.cursor = '';
        if (hovered !== null)
          map.setFeatureState({ source:src, id:hovered }, { hover:false });
        hovered = null;
      });
    }

    // ── WEATHER LAYERS ───────────────────────────────
    async function loadWeather() {
      const r = await fetch(weatherURL);
      const j = await r.json();
      map.addSource('weather-stations', {
        type:'geojson', data:j, cluster:true, clusterMaxZoom:14, clusterRadius:50
      });
      map.addLayer({
        id:'clusters', type:'circle', source:'weather-stations',
        filter:['has','point_count'], paint:{
          'circle-color':'#3887be','circle-radius':15
        }
      });
      map.addLayer({
        id:'unclustered-point', type:'circle', source:'weather-stations',
        filter:['!',['has','point_count']], paint:{
          'circle-color':'#3887be','circle-radius':6,
          'circle-stroke-width':2,'circle-stroke-color':'#fff'
        }
      });
    }

    // ── POPUP STYLING & LOGIC ─────────────────────────
    function makeWeatherHTML(name, temp, wind) {
      return `
        <div style="
          font-family:sans-serif;
          background:#fff;
          padding:4px 8px;
          border-radius:6px;
          box-shadow:0 1px 3px rgba(0,0,0,0.1);
        ">
          <div style="font-size:16px;font-weight:bold;margin-bottom:2px;">
            ${name}
          </div>
          <div style="display:flex;align-items:center;font-size:14px;font-weight:600;">
            <div>${temp}°C</div>
            <div style="margin:0 8px;">|</div>
            <div style="display:flex;align-items:center;">
              <span style="margin-right:4px;">→</span>
              <span>${wind} m/s</span>
            </div>
          </div>
        </div>`;
    }
    const weatherPopups = [];
    function clearWeatherPopups() {
      weatherPopups.forEach(p => p.remove());
      weatherPopups.length = 0;
    }

    // ── UPDATED ZOOMEND ───────────────────────────────
    map.on('zoomend', async () => {
      if (!document.getElementById('weather-toggle').checked) return;
      clearWeatherPopups();
      const z = map.getZoom();
      let popupCount = 0;

      if (z < CLUSTER_BREAK_Z) {
        const clusters = map.querySourceFeatures('weather-stations',
          { filter:['has','point_count'] });
        for (let c of clusters) {
          if (popupCount++ >= WEATHER_POPUP_MAX) break;
          const leaves = await new Promise(res =>
            map.getSource('weather-stations')
              .getClusterLeaves(c.properties.cluster_id, 1, 0, (e,a) => res(a))
          );
          if (!leaves.length) continue;
          const { name, temp, wind } = leaves[0].properties;
          weatherPopups.push(
            new maplibregl.Popup({closeButton:false})
              .setLngLat(c.geometry.coordinates)
              .setHTML(makeWeatherHTML(name, temp, wind))
              .addTo(map)
          );
        }
      } else {
        const pts = map.querySourceFeatures('weather-stations',
          { filter:['!',['has','point_count']] });
        for (let p of pts) {
          if (popupCount++ >= WEATHER_POPUP_MAX) break;
          const { name, temp, wind } = p.properties;
          weatherPopups.push(
            new maplibregl.Popup({closeButton:false})
              .setLngLat(p.geometry.coordinates)
              .setHTML(makeWeatherHTML(name, temp, wind))
              .addTo(map)
          );
        }
      }
    });

    // ── ON LOAD: ROADS → WEATHER → TOGGLE ─────────────
    map.on('load', async () => {
      await loadRoadLayer('low',  21, 0, 6);
      await loadRoadLayer('mid',  22, 5,10);
      await loadRoadLayer('high', 23, 9,24);
      await loadWeather();
      document.getElementById('weather-toggle').addEventListener('change', e => {
        const v = e.target.checked ? 'visible' : 'none';
        map.setLayoutProperty('clusters', 'visibility', v);
        map.setLayoutProperty('unclustered-point', 'visibility', v);
      });
    });

    // ── CLEAN UP ON OUTSIDE CLICK ─────────────────────
    map.on('click', e => {
      const hits = map.queryRenderedFeatures(e.point, {
        layers:['low-line-click','mid-line-click','high-line-click']
      });
      if (!hits.length) {
        removeHighlight();
        clearWeatherPopups();
      }
    });

  </script>
</body>
</html>
