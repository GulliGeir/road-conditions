<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Iceland Road & Weather Map</title>
  <link
    href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css"
    rel="stylesheet"
  />
  <style>
    html, body { margin:0; padding:0; height:100%; }
    #map       { width:100%; height:100%; }
    .maplibregl-popup-content {
      padding:0 !important;
      background:none !important;
      box-shadow:none !important;
      border-radius:0 !important;
    }
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    // — your zoom‐break threshold —
    const CLUSTER_SHOW_Z  = 6;   // clusters only start at zoom 6
    const CLUSTER_BREAK_Z = 10;  // split into stations at zoom 10


    // — roads proxy + weather endpoint —
    const proxy      = 'https://road-conditions.vercel.app/api/proxy?url=';
    const weatherURL = proxy + encodeURIComponent('https://gagnaveita.vegagerdin.is/api/vedur2014_1');

    // — initialize map —
    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://api.maptiler.com/maps/0196e78d-8743-7dbf-90f5-cbede6455991/style.json?key=pbPr4x1AY4Yr8ic8iItZ',
      center: [-19.02, 64.96],
      zoom: 5,
      maxBounds: [[-25, 62.5], [-12, 67.5]],
      minZoom: 5
    });
    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    // — common road helpers & styles —
    function removeHighlight() {
      if (map.getLayer('highlighted-road')) map.removeLayer('highlighted-road');
      if (map.getSource('highlighted-road')) map.removeSource('highlighted-road');
    }
    const statusColors = {
      'GREIDFAERT':'#00DF30','HALKA':'#00B7FF','HALKUBLETTIR':'#FCA433',
      'LOKAD':'#FF0000','OFAERT_VEDUR':'#FF0000','OFAERT_ANNAD':'#FF0000',
      'SNJOTHEKJA':'#FFFFFF','THAEFINGUR':'#FD7EFC','FAERT_FJALLABILUM':'#03DF30',
      'THUNGFAERT':'#3F3F3F','KRAP':'#9C9C9C','OTHEKKT':'#9C9C9C',
      'FLUGHALT':'#0000FF','EKKI_I_THJONUSTU':'#9C9C9C'
    };
    const darkerColors = {
      'GREIDFAERT':'#008b1a','HALKA':'#005b99','HALKUBLETTIR':'#c17300',
      'LOKAD':'#800000','OFAERT_VEDUR':'#800000','OFAERT_ANNAD':'#800000',
      'SNJOTHEKJA':'#cccccc','THAEFINGUR':'#d150d1','FAERT_FJALLABILUM':'#027f17',
      'THUNGFAERT':'#1f1f1f','KRAP':'#6a6a6a','OTHEKKT':'#6a6a6a',
      'FLUGHALT':'#000099','EKKI_I_THJONUSTU':'#6a6a6a'
    };
    const statusText = {
      'GREIDFAERT':'Easily passable','HALKA':'Slippery',
      'HALKUBLETTIR':'Some slippery spots','LOKAD':'Closed',
      'OFAERT_VEDUR':'Impassable due to weather','OFAERT_ANNAD':'Impassable',
      'SNJOTHEKJA':'Snow covered','THAEFINGUR':'Drift snow',
      'FAERT_FJALLABILUM':'Only passable by 4x4','THUNGFAERT':'Heavy traffic',
      'KRAP':'Slush','OTHEKKT':'Unknown','FLUGHALT':'Extremely slippery',
      'EKKI_I_THJONUSTU':'Out of service'
    };

    // — load a road layer as before —
    async function loadRoadLayer(id, arcgisId, minzoom, maxzoom) {
      const srcId = `road-${id}`,
            lineId = `${id}-line`,
            clickId = `${lineId}-click`,
            hoverId = `${lineId}-hover`;

      map.addSource(srcId, { type:'geojson', data:{ type:'FeatureCollection', features:[] } });
      map.addLayer({
        id: lineId,
        type: 'line',
        source: srcId,
        minzoom,
        ...(maxzoom?{maxzoom}:{}),
        paint: {
          'line-color': ['match',['get','ASTAND_YFIRBORD'], ...Object.entries(statusColors).flat(), '#000'],
          'line-width': 4
        }
      });
      map.addLayer({
        id: clickId,
        type: 'line',
        source: srcId,
        minzoom,
        ...(maxzoom?{maxzoom}:{}),
        paint: {
          'line-color': '#000',
          'line-opacity': 0,
          'line-width': 10
        }
      });
      map.addLayer({
        id: hoverId,
        type: 'line',
        source: srcId,
        minzoom,
        ...(maxzoom?{maxzoom}:{}),
        paint: {
          'line-color': '#3388ff',
          'line-width': 6,
          'line-opacity': [
            'case',
            ['boolean',['feature-state','hover'], false],
            1,
            0
          ]
        }
      });

      let hovered = null;
      map.on('mousemove', clickId, e => {
        map.getCanvas().style.cursor = 'pointer';
        if (hovered!==null) map.setFeatureState({ source: srcId, id: hovered }, { hover: false });
        hovered = e.features[0].id;
        map.setFeatureState({ source: srcId, id: hovered }, { hover: true });
      });
      map.on('mouseleave', clickId, () => {
        map.getCanvas().style.cursor = '';
        if (hovered!==null) map.setFeatureState({ source: srcId, id: hovered }, { hover: false });
        hovered = null;
      });

      // fetch & draw features
      const base  = `https://vegasja.vegagerdin.is/arcgis/rest/services/appfaerd/faerd1_2/MapServer/${arcgisId}`;
      const query = `${base}/query?where=1%3D1&outFields=NRVEGUR,ASTAND_YFIRBORD&outSR=4326&f=geojson&resultRecordCount=1000`;

      let all = [], offset = 0, more = true;
      while(more) {
        const resp = await fetch(`${query}&resultOffset=${offset}`);
        const js   = await resp.json();
        all = all.concat(js.features);
        more = js.exceededTransferLimit;
        offset += js.features.length;
      }
      all.forEach((f,i)=>f.id = i);
      map.getSource(srcId).setData({ type:'FeatureCollection', features: all });

      // click → road popup
      map.on('click', clickId, e => {
        const P = e.features[0].properties;
        removeHighlight();
        map.addSource('highlighted-road', { type:'geojson', data: e.features[0] });
        map.addLayer({
          id: 'highlighted-road',
          type: 'line',
          source: 'highlighted-road',
          paint: {
            'line-color': darkerColors[P.ASTAND_YFIRBORD] || '#333',
            'line-width':   6
          }
        });

        const html = `
          <div style="font-family:sans-serif;">
            <div style="
              background:#000;color:#fff;font-weight:bold;font-size:15px;
              padding:8px 10px;display:flex;justify-content:space-between;
              border-radius:8px 8px 0 0;
            ">
              <div>
                <span style="
                  background:#fff;color:#000;border-radius:5px;
                  padding:1px 8px;margin-right:8px;
                  font-size:13px;font-weight:bold;
                ">${P.NRVEGUR||'—'}</span>
                ${P.ASTAND_YFIRBORD}
              </div>
              <button onclick="this.closest('.maplibregl-popup').remove();removeHighlight();"
                style="background:none;border:none;color:white;font-size:16px;cursor:pointer;">
                ×
              </button>
            </div>
            <div style="
              background:#fff;padding:12px;display:flex;align-items:center;
              border-radius:0 0 8px 8px;
            ">
              <span style="
                width:36px;height:12px;background:${statusColors[P.ASTAND_YFIRBORD]};
                border-radius:8px;margin-right:10px;
              "></span>
              <span style="font-size:15px;font-weight:600;">
                ${statusText[P.ASTAND_YFIRBORD]||'Unknown'}
              </span>
            </div>
          </div>
        `;
        new maplibregl.Popup({ closeButton:false })
          .setLngLat(e.lngLat)
          .setHTML(html)
          .addTo(map);
      });
    }

    // — load & cluster weather stations —
    async function loadWeather() {
      const res  = await fetch(weatherURL);
      const data = await res.json();
      const stations = data
        .map(i => ({
          name: i.Nafn || 'Unknown',
          temp: i.Hiti,
          lon: +i.Lengd,
          lat: +i.Breidd
        }))
        .filter(s => !isNaN(s.lon) && !isNaN(s.lat));

      // — 1) source with clustering only up to zoom 9 —
      map.addSource('weather-stations', {
        type: 'geojson',
        data: {
          type: 'FeatureCollection',
          features: stations.map(s => ({
            type: 'Feature',
            geometry: { type:'Point', coordinates:[s.lon,s.lat] },
            properties:{ name:s.name, temp:s.temp }
          }))
        },
        cluster: true,
        clusterMaxZoom: CLUSTER_BREAK_Z - 1,  // ← clustering only up to zoom 9
        clusterRadius: 60
      });

      // — 2) cluster circles, visible zoom 0–9 —
      // — clusters: only from zoom 6 up to 9 —
map.addLayer({
  id: 'weather-clusters',
  type: 'circle',
  source: 'weather-stations',
  filter: ['has','point_count'],
  minzoom: CLUSTER_SHOW_Z,
  maxzoom: CLUSTER_BREAK_Z - 1,
  paint: {
    'circle-color': '#3C8DFF',
    'circle-radius': [
      'step',
      ['get','point_count'],
      10,   10, 15,
      30,  20,
      50,  25
    ]
  }
});

map.addLayer({
  id: 'weather-cluster-count',
  type: 'symbol',
  source: 'weather-stations',
  filter: ['has','point_count'],
  minzoom: CLUSTER_SHOW_Z,
  maxzoom: CLUSTER_BREAK_Z - 1,
  layout: {
    'text-field': '{point_count_abbreviated}',
    'text-font': ['Arial Unicode MS Bold'],
    'text-size': 12
  },
  paint: { 'text-color': '#fff' }
});

// — individual stations: only at zoom 10+ —
map.addLayer({
  id: 'weather-unclustered-point',
  type: 'circle',
  source: 'weather-stations',
  filter: ['!', ['has','point_count']],
  minzoom: CLUSTER_BREAK_Z,
  paint: {
    'circle-color': '#3C8DFF',
    'circle-radius': 6,
    'circle-stroke-width': 1,
    'circle-stroke-color': '#fff'
  }
});

    }

    // — popup HTML builder —
    function makeWeatherHTML(name, temp) {
      return `
        <div style="
          font-family:sans-serif;
          background:#fff;
          padding:8px 12px;
          border-radius:8px;
          box-shadow:0 2px 6px rgba(0,0,0,0.1);
        ">
          <div style="font-weight:600;margin-bottom:4px;">${name}</div>
          <div style="display:flex;align-items:center;">
            <span style="font-size:18px;font-weight:bold;">${temp} °C</span>
            <span style="margin-left:auto;font-size:16px;">→</span>
          </div>
        </div>`;
    }

    // — manage popups on zoom —
    const weatherPopups = [];
    function clearWeatherPopups() {
      weatherPopups.forEach(p => p.remove());
      weatherPopups.length = 0;
    }

    map.on('zoomend', async () => {
      clearWeatherPopups();
      const z = map.getZoom();

      if (z < CLUSTER_BREAK_Z) {
        // one popup per cluster
        const clusters = map.querySourceFeatures('weather-stations', { filter: ['has','point_count'] });
        for (let c of clusters) {
          const cid = c.properties.cluster_id;
          const leaves = await new Promise(res =>
            map.getSource('weather-stations').getClusterLeaves(cid, 1, 0, (err, arr) => res(arr))
          );
          if (!leaves.length) continue;
          const { name, temp } = leaves[0].properties;
          weatherPopups.push(
            new maplibregl.Popup({ closeButton:false })
              .setLngLat(c.geometry.coordinates)
              .setHTML(makeWeatherHTML(name,temp))
              .addTo(map)
          );
        }
      } else {
        // one popup per individual station
        const pts = map.querySourceFeatures('weather-stations', { filter: ['!',['has','point_count']] });
        for (let p of pts) {
          const { name, temp } = p.properties;
          weatherPopups.push(
            new maplibregl.Popup({ closeButton:false })
              .setLngLat(p.geometry.coordinates)
              .setHTML(makeWeatherHTML(name,temp))
              .addTo(map)
          );
        }
      }
    });

    // — on load: fetch weather + draw roads + kick off popups once —
    map.on('load', async () => {
      await loadWeather();
      map.once('idle', () => map.fire('zoomend'));
      await loadRoadLayer('low', 21, 0, 6);
      await loadRoadLayer('mid', 22, 5, 10);
      await loadRoadLayer('high', 23, 9, 24);
    });

    // — clear popups/highlights when clicking outside roads —
    map.on('click', (e) => {
      const hit = map.queryRenderedFeatures(e.point, {
        layers: ['low-line-click','mid-line-click','high-line-click']
      });
      if (!hit.length) {
        removeHighlight();
        clearWeatherPopups();
      }
    });
  </script>
</body>
</html>
