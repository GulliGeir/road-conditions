<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Iceland Road Map with Temperatures</title>
  <link href="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { width: 100%; height: 100%; }
    .maplibregl-popup-content { font-family: sans-serif; padding: 10px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://unpkg.com/maplibre-gl@2.4.0/dist/maplibre-gl.js"></script>
  <script>
    const proxy = 'https://road-conditions.vercel.app/api/proxy?url=';
    const weatherURL = proxy + encodeURIComponent('https://gagnaveita.vegagerdin.is/api/vedur2014_1');

    const map = new maplibregl.Map({
      container: 'map',
      style: 'https://api.maptiler.com/maps/streets/style.json?key=a3sOp8tuMrNynToqbxXE',
      center: [-19.02, 64.96],
      zoom: 6
    });

    map.addControl(new maplibregl.NavigationControl(), 'top-right');

    const statusColors = {
      'GREIDFAERT': '#00DF30',
      'HALKA': '#00B7FF',
      'HALKUBLETTIR': '#FCA433',
      'LOKAD': '#FF0000',
      'OFAERT_VEDUR': '#FF0000',
      'OFAERT_ANNAD': '#FF0000',
      'SNJOTHEKJA': '#FFFFFF',
      'THAEFINGUR': '#FD7EFC',
      'FAERT_FJALLABILUM': '#03DF30',
      'THUNGFAERT': '#3F3F3F',
      'KRAP': '#9C9C9C',
      'OTHEKKT': '#9C9C9C',
      'FLUGHALT': '#0000FF',
      'EKKI_I_THJONUSTU': '#9C9C9C'
    };

    const statusLabels = {
      'GREIDFAERT': 'Passable',
      'HALKA': 'Slippery',
      'HALKUBLETTIR': 'Icy Patches',
      'LOKAD': 'Closed',
      'OFAERT_VEDUR': 'Weather Closure',
      'OFAERT_ANNAD': 'Other Closure',
      'SNJOTHEKJA': 'Snow',
      'THAEFINGUR': 'Fog',
      'FAERT_FJALLABILUM': '4×4 Only',
      'THUNGFAERT': 'Heavy Traffic',
      'KRAP': 'Slush',
      'OTHEKKT': 'Unknown',
      'FLUGHALT': 'Airport Halted',
      'EKKI_I_THJONUSTU': 'No Service'
    };

    let weatherStations = [];

    async function loadWeather() {
  try {
    const response = await fetch(weatherURL);
    const json = await response.json(); // it's JSON, not XML

    console.log("✅ Weather JSON:", json);

    weatherStations = json.map(i => ({
      name: i.Nafn || 'Unknown',
      temp: i.Hiti ?? '—',
      lon: parseFloat(i.Lengd),
      lat: parseFloat(i.Breidd)
    })).filter(s => !isNaN(s.lon) && !isNaN(s.lat));

    console.log('✅ Weather stations parsed:', weatherStations.length);
  } catch (err) {
    console.error('❌ Weather load error:', err);
  }
}



function getNearestStation(lng, lat) {
  if (!weatherStations.length) return null;

  let nearest = null;
  let minDist = Infinity;

  for (const st of weatherStations) {
    const dx = lng - st.lon;
    const dy = lat - st.lat;
    const dist = dx * dx + dy * dy;
    if (dist < minDist) {
      minDist = dist;
      nearest = st;
    }
  }

  return nearest; // always return the closest one
}

    async function loadRoadLayer(id, arcgisId, minzoom, maxzoom) {
      const srcId = `road-${id}`;
      map.addSource(srcId, { type: 'geojson', data: { type: 'FeatureCollection', features: [] } });

      map.addLayer({
        id: `${id}-line`,
        type: 'line',
        source: srcId,
        minzoom,
        ...(maxzoom ? { maxzoom } : {}),
        paint: {
          'line-color': [
            'match', ['get', 'ASTAND_YFIRBORD'],
            ...Object.entries(statusColors).flat(),
            '#000000'
          ],
          'line-width': 2
        }
      });

      map.addLayer({
        id: `${id}-click`,
        type: 'line',
        source: srcId,
        layout: {},
        paint: {
          'line-color': 'rgba(0,0,0,0)',
          'line-width': 10
        }
      });

      map.on('click', `${id}-click`, (e) => {
        const f = e.features[0];
        const p = f.properties;
        const label = statusLabels[p.ASTAND_YFIRBORD] || p.ASTAND_YFIRBORD;

        const coords = f.geometry.coordinates.flat();
        const mid = coords[Math.floor(coords.length / 2)];
        const nearest = getNearestStation(mid[0], mid[1]);
        const tempText = nearest
          ? Temperature: ${nearest.temp}°C at ${nearest.name} (${Math.sqrt(minDist).toFixed(2)}°)
          : 'Weather station not found';

        new maplibregl.Popup({ offset: 10 })
          .setLngLat(e.lngLat)
          .setHTML(`
            <strong>Road ${p.NRVEGUR}</strong><br>
            Condition: ${label}<br>
            Temperature: ${tempText}
          `)
          .addTo(map);
      });

      map.on('mouseenter', `${id}-click`, () => map.getCanvas().style.cursor = 'pointer');
      map.on('mouseleave', `${id}-click`, () => map.getCanvas().style.cursor = '');

      const base = `https://vegasja.vegagerdin.is/arcgis/rest/services/appfaerd/faerd1_2/MapServer/${arcgisId}`;
      const query = `${base}/query?where=1%3D1&outFields=NRVEGUR,ASTAND_YFIRBORD&outSR=4326&f=geojson&resultRecordCount=1000`;

      const all = [];
      let offset = 0, more = true;
      while (more) {
        const res = await fetch(`${query}&resultOffset=${offset}`);
        const json = await res.json();
        all.push(...json.features);
        more = json.exceededTransferLimit;
        offset += json.features.length;
      }

      map.getSource(srcId).setData({ type: 'FeatureCollection', features: all });
    }

    map.on('load', async () => {
      await loadWeather();
      await loadRoadLayer('low', 21, 0, 6);
      await loadRoadLayer('mid', 22, 5, 10);
      await loadRoadLayer('high', 23, 9, 24);
    });
  </script>
</body>
</html>
